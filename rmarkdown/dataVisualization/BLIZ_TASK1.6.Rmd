---
title: "BLIZ_TASK1.6"
author: "Maria Inês Silva"
date: "2024-01-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages

```{r, include=FALSE}
library(dplyr)
library(collapse)
library(fs)
library(tidyverse) 
library(readxl)
library(writexl)
library(ggplot2)
library(raster)
library(gridExtra)
library(DT) # functions to produce nicely formatted tables
library(stringr)
```

# Import data

```{r, message=FALSE}
library(readr)
dataset <- read_delim("example_output.tsv", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE)
#View(dataset)
```

```{r}
summary(dataset)
str(dataset)
```

# 1. Dummy datasets

### 1.1. 6 species

```{r, }
vector1<-c(1,1,1,2,2,2,2,2) # vector with multiplication factors for each column
dataset2<- dataset*vector1[col(dataset)] #new dataset for sps2
dataset2$species <- "B"
#dataset2

vector2<-c(1,1,1,3,3,2,3,3) # vector with multiplication factors for each column
dataset3<- dataset*vector2[col(dataset)] #new dataset for sps3
dataset3$species <- "C"
#dataset3

vector3<-c(1,1,1,0.5,3,2,3.5,1.5) # vector with multiplication factors for each column
dataset4<- dataset*vector3[col(dataset)] #new dataset for sps4
dataset4$species <- "D"
#dataset4

vector4<-c(1,1,1,2,3,4.5,5,0.5) # vector with multiplication factors for each column
dataset5<- dataset*vector4[col(dataset)] #new dataset for sps5
dataset5$species <- "E"
#dataset5

vector5<-c(1,1,1,0.7,3,2.5,4,1) # vector with multiplication factors for each column
dataset6<- dataset*vector5[col(dataset)] #new dataset for sps6
dataset6$species <- "F"
#dataset6

dataset$species <- "A" 
#dataset

```

### 1.2. 7 environmental scenarios

```{r}
#Dummy dataset with all sps
all_sps <- do.call("rbind", list(dataset, dataset2, dataset3, dataset4, dataset5, dataset6))
all_sps$t<-as.factor(all_sps$t)
all_sps$x<-as.factor(all_sps$x)
all_sps$y<-as.factor(all_sps$y)
all_sps$scenario <- "controlRun"
summary(all_sps)
str(all_sps)

write.csv(all_sps, "all_sps_controlRun.csv", row.names = FALSE) #dummy dataset for all species in scenario controlRun
```

```{r, message=FALSE}
all_sps_clim_SSP1 <- all_sps %>% mutate_if(is.numeric, ~. *3) #dummy dataset for all species in scenario CLIMATE SSP1
all_sps_clim_SSP1$scenario <- "clim_SSP1"
#all_sps_clim_SSP1
#summary(all_sps_clim_SSP1)
write.csv(all_sps_clim_SSP1, "all_sps_clim_SSP1.csv", row.names = FALSE)  

all_sps_clim_SSP5 <- all_sps %>% mutate_if(is.numeric, ~. *5) #dummy dataset for all species in scenario CLIMATE SSP5
all_sps_clim_SSP5$scenario <- "clim_SSP5"
#all_sps_clim_SSP1
#summary(all_sps_clim_SSP5)
write.csv(all_sps_clim_SSP5, "all_sps_clim_SSP5.csv", row.names = FALSE) 

all_sps_land_SSP1 <- all_sps %>% mutate_if(is.numeric, ~. *1.5) #dummy dataset for all species in scenario LAND-USE SSP1
all_sps_land_SSP1$scenario <- "land_SSP1"
#all_sps_clim_SSP1
#summary(all_sps_land_SSP1)
write.csv(all_sps_land_SSP1, "all_sps_land_SSP1.csv", row.names = FALSE) 

all_sps_land_SSP5 <- all_sps %>% mutate_if(is.numeric, ~. *3.5) #dummy dataset for all species in scenario LAND-USE SSP5
all_sps_land_SSP5$scenario <- "land_SSP5"
#all_sps_clim_SSP1
#summary(all_sps_land_SSP5)
write.csv(all_sps_land_SSP5, "all_sps_land_SSP5.csv", row.names = FALSE) 

all_sps_clim_land_SSP1 <- all_sps %>% mutate_if(is.numeric, ~. *7) #dummy dataset for all species in scenario CLIMATE & LAND-USE SSP1
all_sps_clim_land_SSP1$scenario <- "clim_land_SSP1"
#all_sps_clim_SSP1
#summary(all_sps_clim_land_SSP1)
write.csv(all_sps_clim_land_SSP1, "all_sps_clim_land_SSP1.csv", row.names = FALSE) 

all_sps_clim_land_SSP5 <- all_sps %>% mutate_if(is.numeric, ~. *0.5) #dummy dataset for all species in scenario CLIMATE & LAND-USE SSP5
all_sps_clim_land_SSP5$scenario <- "clim_land_SSP5"
#all_sps_clim_SSP1
#summary(all_sps_clim_land_SSP5)
write.csv(all_sps_clim_land_SSP5, "all_sps_clim_land_SSP5.csv", row.names = FALSE)
```

```{r, message=FALSE}
#Combining all 7 scenarios for all 6 species
data_all <- list.files(path = "C:/Users/User/OneDrive - Universidade de Lisboa/BLIZ_1.6_ANDRE",  # Identify all CSV files
                       pattern = "*.csv", full.names = TRUE) %>%
  lapply(read_csv) %>%
  bind_rows
#summary(data_all)
#str(data_all)
```

# 2. New variables in the dataset

### Occupancy

```{r}
#create new column with variable OCCUPANCY, based on whether a cell has at least one value
data_all <- data_all %>%
  mutate(occupancy = ifelse(data_all$abundance > 0, 1, 0)) 
```

### Abundance change

```{r}
#create new column with variable ABUNDANCE CHANGE, based on the abundance in a given time step
data_all <- data_all %>%
  group_by(species, scenario) %>% 
  mutate(abund_change <- abundance - abundance[t == 1]) %>%
  ungroup()
```

### Occupancy change

```{r}
#create new column with variable OCCUPANCY CHANGE, based on the occupancy in a given time step
data_all <- data_all %>%
  group_by(species, scenario) %>% 
  mutate(occup_change <- occupancy - occupancy[t == 1]) %>%
  ungroup()
```

### Abundance mismatch

```{r}
#create new column with variable ABUNDANCE MISMATCH, based on the carrying capacity in a given time step - abundance in a given time step
data_all <- data_all %>%
  group_by(species, scenario) %>% 
  mutate(abund_mismatch <- carry - abundance) %>%
  ungroup()
```

### Habitat change

```{r}
#create new column with variable HABITAT CHANGE, based on the habitat in a given time step
data_all <- data_all %>%
  group_by(species, scenario) %>% 
  mutate(habitat_change <- habitat - habitat[t == 1]) %>%
  ungroup()
```


```{r}
#Change columns names
colnames(data_all) <- c("t", "x", "y",  "abundance", "reproduction", "habitat", "carry",  "bevmort", "species", "scenario", "occupancy", "abund_change", "occup_change", "abund_mismatch", "habitat_change" )
```

# 3. Population-level Plots

### Plot theme

```{r, warning=FALSE}
#definition of the population plots' theme
line_plots_theme <- theme_minimal() +
  theme(# Customise the background grids
        panel.grid.major =  element_line(color = "gray90", size = 0.25),
        panel.grid.minor = element_blank(),
        # Add Bold legend titles
        legend.title = element_text(face = "bold"),
        # Italic, slightly larger facet titles 
        strip.text = element_text(face = "italic", size = rel(0.8)),
        # Bold axis titles
        axis.title = element_text(face = "bold"),
        # Set tick label color, margin, and size
        axis.text.y=element_text(colour="black" ,margin=margin(t=0,r=1,b=0,l=0), size = 9),
        axis.text.x=element_text(colour="black", margin=margin(t=1,r=0,b=0,l=0), size = 9))
```

### Selected variables mean and standard deviation values table

```{r}
data_all_subset<-data_all[, c(1,4:10)]
#Mean and standard deviation for ABUNDANCE, REPRODUCTION, CARRYING CAPACITY, HABITAT SUITABILITY and MORTALITY variables
mean_stDEV <- data_all_subset %>%
  dplyr::group_by(species, scenario, t) %>%
  dplyr::summarise(across(c(abundance, reproduction, carry, habitat, bevmort), .f = list(mean = mean, sd = sd), na.rm = TRUE), .groups = 'drop') %>%
  dplyr::mutate(across(where(is.numeric), round, 3)) 
print(mean_stDEV)

#Export mean and standard deviation into a .csv file
#write.csv(mean_stDEV, "all_sps_mean.csv", row.names = FALSE)  # do not save in the same folder as the scenarios data or chunk nº8 will read this file too 
```


```{r}
# design custom table containers for the DT table
sketch = htmltools::withTags(table(
 class = 'display',
  thead(
    tr(
    th(rowspan = 2, 'Species'), # the species, scenario and Time step headers span 2 rows
    th(rowspan = 2, 'Scenario'),
    th(rowspan = 2, 'Time step'),
    th(colspan = 2, 'Abundance'), # the headers Abundance, Reproduction, Habitat suitability, Carrying capacity and Mortality span 2 columns each (1 for the mean value and other for the standard deviation)
    th(colspan = 2, 'Reproduction'),
    th(colspan = 2, 'Habitat suitability'),
    th(colspan = 2, 'Carrying capacity'),
    th(colspan = 2, 'Mortality')
   ),
    tr(
     lapply(rep(c('Mean', 'St. Dev.'), 5), th) # repeat "Mean" and "St. Dev." 5 times (5 headers)
  ))))

datatable(mean_stDEV, container = sketch, rownames = FALSE) # obtain a nicely formatted table
```


### Abundance through time

```{r, fig.dim=c(12,8)}
abund_plot2 <- ggplot(mean_stDEV, aes(x = t, y = abundance_mean, group=scenario, color = scenario)) + 
  geom_line() + # line plot
  geom_ribbon(aes(x = t, ymin = abundance_mean - abundance_sd, ymax = abundance_mean + abundance_sd, fill = scenario), alpha = 0.3, colour = NA) + # add ribbon with standard deviation values
  facet_wrap(. ~ species, ncol =3, scales = "free_y") +  # one vertical panel for each species
  scale_fill_viridis_d(option = "D") + # colour palette
  scale_color_viridis_d(option = "D") + 
  labs(x ="Time" , y = "Abundance", color = "Scenarios", fill = "Scenarios") + # axis labels
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.1))) + # set xx axis to start at zero and more space at the top of the yy axis
  line_plots_theme + 
  theme(legend.position="bottom")
abund_plot2

#Save abundance through time plot
#ggsave(plot = abund_plot2, file = "Abundance_through_time.tiff", bg = 'white', width = 170, height = 100, units = "mm", dpi = 1200, compression = "lzw")
```

### Reproduction through time

```{r, fig.dim=c(12,8)}
reprod_plot <- ggplot(mean_stDEV, aes(x = t, y = reproduction_mean, group=scenario, color = scenario)) +
  geom_line() + # line plot
  geom_ribbon(aes(x = t, ymin = reproduction_mean - reproduction_sd, ymax = reproduction_mean + reproduction_sd, fill = scenario), alpha = 0.3, color =NA) + # add ribbon with standard deviation values
  facet_wrap(. ~ species, ncol = 3, scales = "free_y") + # one vertical panel for each species
  scale_fill_viridis_d(option = "D") + # colour palette
  scale_color_viridis_d(option = "D") + 
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.1))) +  # set xx axis to start at zero and more space at the top of the yy axis
  labs(x ="Time", y = "Reproduction", color = "Scenarios", fill = "Scenarios") + # axis labels (note: fill and color must have the same name to have only one legend)
  line_plots_theme +
  theme(legend.position = "bottom")
reprod_plot

#Save reproduction through time plot
#ggsave(plot = reprod_plot, file = "Reproduction_through_time.tiff",  bg = 'white', width = 170, height = 100, units = "mm", dpi = 1200, compression = "lzw")
```

### Habitat suitability through time

```{r, fig.dim=c(12,8)}
habitat_plot <- ggplot(mean_stDEV, aes(x = t, y = habitat_mean, group=scenario, color = scenario)) +
  geom_line() + # line plot
  geom_ribbon(aes(x = t, ymin = habitat_mean - habitat_sd, ymax = habitat_mean + habitat_sd, fill = scenario), alpha = 0.3, color = NA) + # add ribbon with standard deviation values
  facet_wrap(. ~ species, ncol = 3, scales = "free_y") + # one vertical panel for each species
  scale_fill_viridis_d(option = "D") + # colour palette
  scale_color_viridis_d(option = "D") + 
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.1))) +  # set xx axis to start at zero and more space at the top of the yy axis
  labs( x ="Time" , y = "Habitat suitability", color = "Scenarios", fill = "Scenarios") + # axis labels (note: fill and color must have the same name to have only one legend)
  line_plots_theme + 
  theme(legend.position = "bottom")
habitat_plot

#Save habitat suitability through time plot
#ggsave(plot = habitat_plot, file = "Habitat_suitability_through_time.tiff",  bg = 'white', width = 170, height = 100, units = "mm", dpi = 1200, compression = "lzw")
```

### Carrying capacity through time

```{r, fig.dim=c(12,8)}
carry_cap_plot <- ggplot(mean_stDEV, aes(x = t, y = carry_mean, group=scenario, color = scenario)) +
  geom_line() + # line plot
  geom_ribbon(aes(x = t, ymin = carry_mean - carry_sd, ymax = carry_mean + carry_sd, fill = scenario), alpha = 0.3, color = NA) +  # add ribbon with standard deviation values
  facet_wrap(. ~ species, ncol = 3, scales = "free_y") + # one vertical panel for each species
  scale_fill_viridis_d(option = "D") + # colour palette
  scale_color_viridis_d(option = "D") + 
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.1))) +  # set xx axis to start at zero and more space at the top of the yy axis
  labs( x ="Time" , y = "Carrying capacity", color = "Scenarios", fill = "Scenarios") + # axis labels (note: fill and color must have the same name to have only one legend)
  line_plots_theme + 
  theme(legend.position = "bottom")
carry_cap_plot

#Save carrying capacity through time plot
#ggsave(plot = carry_cap_plot, file = "Carrying_capacity_through_time.tiff",  bg = 'white', width = 170, height = 100, units = "mm", dpi = 1200, compression = "lzw")
```

### Mortality through time

```{r, fig.dim=c(12,8)}
mort_plot <- ggplot(mean_stDEV, aes(x = t, y = bevmort_mean, group = scenario, color = scenario)) +
  geom_line() + # line plot
  geom_ribbon(aes(x = t, ymin = bevmort_mean - bevmort_sd, ymax = bevmort_mean + bevmort_sd, fill = scenario), alpha = 0.3, color = NA) + # add ribbon with standard deviation values
  facet_wrap(. ~ species, ncol = 3, scales = "free_y") + # vertical panels for each species distributed in e columns
  scale_fill_viridis_d(option = "D") + # colour palette
  scale_color_viridis_d(option = "D") + 
  scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.1))) +  # set xx axis to start at zero and more space at the top of the yy axis
  labs( x ="Time" , y = "Carrying capacity", color = "Scenarios", fill = "Scenarios") + # axis labels (note: fill and color must have the same name to have only one legend)
  line_plots_theme + 
  theme(legend.position = "bottom")
mort_plot

#Save mortality through time plot
#ggsave(plot = mort_plot, file = "Mortality_through_time.tiff",  bg = 'white', width = 170, height = 100, units = "mm", dpi = 1200, compression = "lzw")
```

### Abundance mismatch per scenario

```{r, fig.dim=c(12,8)}
abund_mismatch_plot <- ggplot(data_all, aes(x=as.factor(scenario), y= abund_mismatch, fill = scenario)) +
  geom_boxplot() + 
  labs(x = "SSP scenarios", y = "Abundance Mismatch", fill ="Scenarios") + #axis labels
  facet_wrap(. ~ species, ncol = 3, scales = "free_y") + #one vertical panel per species "SO UM EIXO FREE"
  scale_fill_viridis_d(option = "D") +
  line_plots_theme + 
  theme(panel.background =  element_blank(),
        panel.grid.major =  element_line(color = "gray90", size = 0.25),
        panel.grid.minor = element_line(color = "gray90", size = 0.25),
        axis.text.x = element_text(angle = 60, vjust = 1.0, hjust = 1.0),
        legend.position = "bottom")
abund_mismatch_plot
  
#Save abundance mismatch per scenario plot
#ggsave(plot = abund_mismatch_plot, file = "Abundance_mismatch.tiff",  bg = 'white', width = 170, height = 100, units = "mm", dpi = 1200, compression = "lzw")
```

# 4. Cell-level plots (per species)

### Abundance change spatial map

```{r, fig.dim=c(12,8)}
# subset data for the last time step (t =40)
abund_t40<-data_all[data_all$t == 40,]

# plot the the abundance change for the last time step
abund_change_map <- ggplot() +
  geom_raster(data = abund_t40, aes(x = y, y = x, fill = abund_change)) +
  facet_wrap(species ~ . ) + # vertical panels for each species in 3 columns
  scale_fill_viridis_c("Abundance \nchange", option = "H", na.value = "transparent") + # legend title, color scale (option H = Turbo which is colorblind friendly), transparent background on each plot
  labs(x = "Longitude ", y ="Latitude ") + # axis labels
  theme(panel.background =  element_blank(), # no background grids
        # facets identification customization
        strip.background =  element_rect(fill = "grey94", color = "black"), 
        strip.text = element_text(face = "italic", size = rel(0.8)), 
        panel.border =element_rect(color = "black", fill = NA),
        # axis and legend font type
        legend.title = element_text(face = "bold"), 
        axis.title = element_text(face = "bold"))
abund_change_map

#Save abundance change spatial map per species plot
#ggsave(plot = abund_change_map, file = "Abundance_change_spatial_map.tiff", bg = "transparent", width = 170, height = 100, units = "mm", dpi = 1200, compression = "lzw")
```

### Habitat suitability change spatial map

```{r, fig.dim=c(12,8)}
#plot the the habitat suitability change for the last time step
habitat_change_map <- ggplot() +
  geom_raster(data = abund_t40, aes(x = y, y = x, fill = habitat_change)) +
  facet_wrap(species ~ .) + # vertical panels for each species distributed in 3 columns
  scale_fill_viridis_c("Habitat \nsuitability change", option = "H", na.value = "transparent") +
  labs(x = "Longitude ", y ="Latitude ") +
  theme(panel.background =  element_blank(), # no background grids
        # facets identification customization
        strip.background =  element_rect(fill = "grey94", color = "black"), 
        strip.text = element_text(face = "italic", size = rel(0.8)), 
        panel.border =element_rect(color = "black", fill = NA),
        # axis and legend font type
        legend.title = element_text(face = "bold"), 
        axis.title = element_text(face = "bold"))
habitat_change_map

#Save habitat suitability change spatial map per species plot
#ggsave(plot = habitat_change_map, file = "Habitat suitability_change_spatial_map.tiff", bg = "transparent", width = 170, height = 100, units = "mm", dpi = 1200, compression = "lzw")
```

### Correlation plot between abundance change and habitat suitability change

```{r, warning=FALSE, fig.dim=c(12,8)}
# subset of the data for the controlRun for abund_change and habitat_change variables
corr_data <- data_all[data_all$scenario == "controlRun" , c(9,12,15)]

# function to write the model equation and the r2 
lm_labels <- function(df) {
  mod <- lm(abund_change ~ habitat_change, data = df)
  formula <- sprintf("italic(y) == %.2f %+.2f * italic(x)",
                     round(coef(mod)[1], 2), round(coef(mod)[2], 2)) # write the equation formula
  r2 <- sprintf("italic(R^2) == %.2f", summary(mod)$r.squared) # write th r2 for each group
  data.frame(formula = formula, r2 = r2, stringsAsFactors = FALSE)
}
# SPRINTF function → returns a character vector containing a formatted combination of text and variable values

# create dataframe with the equations and r2
labels <- corr_data %>%
  group_by(species) %>% # group data by species
  do(lm_labels(.)) # use the function above to create the dataframe with equation and r2 for each species
labels # visualize lables created


sp_corr_plots <- ggplot(corr_data, aes(x = habitat_change, y = abund_change)) +
  geom_point(alpha = 0.3) +
  facet_wrap(species ~ .) + # one pannel for each species
  labs(x = "Habitat suitability change", y = "Abundance change") + # label axis
  stat_smooth(method = "lm", formula = y~x) + # plot a linear regression model for each species
  geom_text(data = labels, aes(label = formula), x = 0, y = -250000, parse = TRUE, hjust = 0, size = 7/.pt) + # label for the equation
  geom_text(x = 0, y = -350000, aes(label = r2), data = labels, parse = TRUE, hjust = 0, size = 7/.pt) + # label for the r2
  theme_minimal() + # main theme
  theme(panel.background =  element_blank(), # no background colour
        # background grids customization
        panel.grid.major =  element_blank(), 
        panel.grid.minor = element_line(color = "gray90", size = 0.25),
        # facets identification customization
        strip.text = element_text(face = "italic", size = rel(0.8)), 
        # axis and legend font type
        legend.title = element_text(face = "bold"), 
        axis.title = element_text(face = "bold"))
sp_corr_plots

#Save  Correlation between abundance change and habitat suitability change per species plot
#ggsave(plot = sp_corr_plots, file = "correlation_plots_species.tiff",  bg = 'white', width = 170, height = 100, units = "mm", dpi = 1200, compression = "lzw")
```

# 5. Sensitivity analysis (per species)

### New dummy dataset

```{r}
controlRun<- all_sps[all_sps$t == 40, c(1,4,5,6,7,8,9)] # subset controlRun data variables for all species
summary(controlRun)

set.seed(12) # to obtain reproducible values
v_b105 <- runif(5, 0.6, 1.4) # b 105 simulation vector
v_b95 <- runif(5, 0.6, 1.4) # b 95 simulation vector
# sample function only finds whole numbers

v_Mean_Disp105 <- runif(5, 0.6, 1.4) # MeanDispersal 105 simulation vector
v_Mean_Disp95 <- runif(5, 0.6, 1.4) # MeanDispersal 955 simulation vector


b105 <- as.data.frame(t(t(controlRun[2:6])*v_b105))
colnames(b105) <- paste(colnames(b105),"b105",sep="_") # add _b105 to each column

b95 <- as.data.frame(t(t(controlRun[2:6])*v_b95))  # create b95 simulation by multiplying the controlRun dataset by the random vector v_b95
colnames(b95) <- paste(colnames(b95),"b95",sep="_")  # add _95 to each column

Mean_Disp105 <- as.data.frame(t(t(controlRun[2:6])*v_Mean_Disp105)) # create MeanDispersal 105 simulation by multiplying the controlRun dataset by the random vector v_Mean_Disp105
colnames(Mean_Disp105) <- paste(colnames(Mean_Disp105),"Mean_Disp105",sep="_") # add _Mean_Disp105 to each column

Mean_Disp95 <- as.data.frame(t(t(controlRun[2:6])*v_Mean_Disp95)) # create MeanDispersal 95 simulation by multiplying the controlRun dataset by the random vector v_Mean_Disp95
colnames(Mean_Disp95) <- paste(colnames(Mean_Disp95),"Mean_Disp95",sep="_") #add _Mean_Disp95 to each column

sensitive_runs <- cbind(controlRun,b105) %>% # combine all simulations data
  cbind(.,b95) %>%
  cbind(.,Mean_Disp105) %>%
  cbind(.,Mean_Disp95)

sensitive_runs <- sensitive_runs %>% relocate(species, .after=t) # move species column to after t column
#str(sensitive_runs)


sensitive_runs <- sensitive_runs %>% 
    mutate(# abundance    
         abund_prop_b105 = abundance_b105 / abundance,
         abund_prop_b95 = abundance_b95 / abundance,
         abund_prop_MeanDisp105 = abundance_Mean_Disp105 / abundance,
         abund_prop_MeanDisp95 = abundance_Mean_Disp95 / abundance,
        # reproduction
        reprod_prop_b105 = reproduction_b105 / reproduction,
         reprod_prop_b95 = reproduction_b95 / reproduction,
         reprod_prop_MeanDisp105 = reproduction_Mean_Disp105 / reproduction,
         reprod_prop_MeanDisp95 = reproduction_Mean_Disp95 / reproduction,
        # habitat
        hab_prop_b105 = habitat_b105 / habitat,
         hab_prop_b95 = habitat_b95 / habitat,
         hab_prop_MeanDisp105 = habitat_Mean_Disp105 / habitat,
         hab_prop_MeanDisp95 = habitat_Mean_Disp95 / habitat,
        #carrying capacity
        carry_prop_b105 = carry_b105 / carry,
         carry_prop_b95 = carry_b95 / carry,
         carry_prop_MeanDisp105 = carry_Mean_Disp105 / carry,
         carry_prop_MeanDisp95 = carry_Mean_Disp95 / carry,
        #bevmort
        bevmort_prop_b105 = bevmort_b105 / bevmort,
         bevmort_prop_b95 = bevmort_b95 / bevmort,
         bevmort_prop_MeanDisp105 = bevmort_Mean_Disp105 / bevmort,
         bevmort_prop_MeanDisp95 = bevmort_Mean_Disp95 / bevmort) 

#str(sensitive_runs)
```


### Table with controlRun and sensitive mean values

```{r}
sensRuns_means <- sensitive_runs %>%
  group_by(species) %>% # group by species
  summarise(across(where(is.numeric), .f = \(x) mean(x, na.rm = TRUE)) ) %>% # mean value for each variable in each simulation
  mutate(across(where(is.numeric), round, 3)) 

# variables names
names_var <- c("species", "abundance", "abundance_b105", "abundance_b95", "abundance_Mean_Disp105", "abundance_Mean_Disp95", "reproduction", "reproduction_b105", "reproduction_b95", "reproduction_Mean_Disp105",  "reproduction_Mean_Disp95", "habitat", "habitat_b105",  "habitat_b95", "habitat_Mean_Disp105", "habitat_Mean_Disp95",  "carry", "carry_b105", "carry_b95", "carry_Mean_Disp105",  "carry_Mean_Disp95", "bevmort", "bevmort_b105",  "bevmort_b95",   "bevmort_Mean_Disp105",  "bevmort_Mean_Disp95")

sensRuns_means_reorder <- sensRuns_means[,match(names_var, colnames(sensRuns_means))]

#Export mean and standard deviation into a .csv file
#write.csv(sensRuns_means_reorder, "sensitive_runs_mean_values.csv", row.names = FALSE)  # do not save in the same folder as the scenarios data or chunk nº8 will read this file too 
```

```{r}
sensRuns_means_reorder_t <- data.frame(t(sensRuns_means_reorder[-1])) # transpose table for easier read
colnames(sensRuns_means_reorder_t) <- c("A", "B" , "C", "D", "E", "F") # set column names with species names

# nicely formatted tables
datatable(sensRuns_means_reorder_t,
          caption = 'Table x: Mean values ofr each variable in each run.')  # table caption
```

### Simulations boxplot

```{r}
#change data format for boxplot
simulations_long <- sensitive_runs %>% 
                      pivot_longer(cols=c(28:46), # change variable columns from wide to long format = stacking the columns
                      names_to='Var_sim', #new column with variables names
                      values_to='Value') #new colum with values

simulations_long[c('Variable', 'Simulation')] <- str_split_fixed(simulations_long$Var_sim, '_', 2) #split var_sim column to have one with the variable name and other with the simulation name

simulations_long <- simulations_long[c( 'species', 'Variable', 'Simulation', 'Value')] #select the columns needed
#summary(simulations_long)
```


```{r, fig.dim=c(12,8)}
variables.labs <- c("Abundance", "Mortality", "Carrying capacity" , "Habitat suitability", "Reproduction")
names(variables.labs) <- c("abund", "bevmort", "carry" , "hab", "reprod")

#plot boxplot for each variable in each simulation
sens_analysis <- ggplot(simulations_long, aes(x=as.factor(Simulation), y = Value)) +
  geom_boxplot() + 
  facet_wrap(. ~ Variable, labeller = labeller(Variable = variables.labs), as.table = F) +
  stat_summary(fun = mean, geom = "point", aes(group = interaction(species, Variable, Simulation), color=species), shape = 16, size = 1.5, position =  position_jitter(width = .5, height = 0)) +
   scale_color_viridis_d(option = "D") +
  labs(x = "Simulation", y = "Value", color ="Species") + 
  geom_hline(yintercept= 1.2, linetype="dashed", color = "red") + 
  geom_hline(yintercept= 0.8, linetype="dashed", color = "red") + 
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 60, vjust = 1.0, hjust = 1.0),
        panel.background =  element_blank(),
        panel.grid.major =  element_line(color = "gray90", size = 0.25),
        panel.grid.minor = element_line(color = "gray90", size = 0.25),
        #facets identification customization
        strip.text = element_text(face = "bold", size = rel(0.8)), 
        #axis and legend font type
        legend.title = element_text(face = "bold"), 
        axis.title = element_text(face = "bold"),
        legend.key = element_rect(fill = "white", colour = NA))
sens_analysis

#Save abundance mismatch per scenario plot
#ggsave(plot = sens_analysis, file = "Sensitivity_analysis.tiff",  bg = 'white', width = 170, height = 100, units = "mm", dpi = 1200, compression = "lzw")
```

