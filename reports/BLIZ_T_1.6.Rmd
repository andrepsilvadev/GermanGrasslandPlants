---
title: "BLIZ_T_1.6"
author: "Maria Inês Silva"
date: "2024-08-29"
output: 
  html_document:
    code_folding: hide
    theme: cosmo
    highlight: haddock
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Task 1.6

Find task description and steps [here](https://docs.google.com/document/d/1iZgTCRGpT9baVUdXMkWK5A_20XG0AUy6L-NgqjmQn3s/edit)

Find and download the source code from
[here](https://github.com/andrepsilvadev/MetaRange/blob/dev/src/BLIZ1.6_31Aug.R)

The model (metarange) predicts abundance of the species for all the cells in the landscape (in this case two states in Germany - Bavaria and Baden-Württemberg).


```{r, include=FALSE}
source("BLIZ1.6_31Aug.R", local =  knitr::knit_global())
```

## Step 1 - Import and merge all output files

```{r, eval=FALSE}
all_data <- list.files(recursive = T) %>% #get a list of the paths to datasets files
  map_dfr(function(path) {
 #retrieve any characters from the beginning of the path until /
  foldername <- str_extract(path, "^.+(?=/)")
  fread(path) %>% #import the files  
  mutate(folder = foldername) # add a new collumn with the folder name
})
invisible(gc())

all_data <- all_data %>%
  separate(folder, c("date", "time", "species", "scenario"), sep = "_", remove = FALSE) %>% #takes a VERY long time ^(more than 40 minutes)
  dplyr::select(-c("folder", "date", "time"))
invisible(gc())

#check for negative values in abundance
summary(all_data)
#rows with negative abundances
bb <- as.data.frame(which(all_data < 0 , arr.ind=TRUE))
bb <- bb[bb$col == 4,]

#values <- as.vector(bb$row)
aa <- all_data[values,]

#write tsv file with all species in all scenarios
write_tsv(all_data, "full_dataset.tsv")

#Import the complete dataset 
all_data <- fread("./full_dataset.tsv", integer64 = "numeric")
nvisible(gc())
```


## Step 2 - Create new variables

**Occupancy** - cells with at least one individual

The following variables are all calculated in relation to time step 25, which corresponds to the end of the burn-in period that allows the species to stabilize (the model has reached it stationary region).

**Abundance change** - $abundance_{tn} - abundance_{t25}$

**Occupancy change** - $ocupancy_{tn} - occupancy_{t25}$

**Habitat change** - $habitat\ suitability_{tn} - habitat\ suitability_{t25}$

```{r, eval=FALSE}
#################################
# STEP 2 - CREATE NEW VARIABLES #
#################################

# occupancy
all_data <- all_data %>%
  mutate(occupancy = ifelse(all_data$abundance > 0, 1, 0)) 
invisible(gc())

# abundance change
all_data <- all_data %>%
  group_by(species, scenario) %>% 
  mutate(abund_change <- abundance - abundance[t == 25]) %>%
  ungroup()
invisible(gc())

# occupancy change
all_data <- all_data %>%
  group_by(species, scenario) %>% 
  mutate(occup_change <- occupancy - occupancy[t == 25]) %>%
  ungroup()
invisible(gc())

# habitat suitability change
all_data <- all_data %>%
  group_by(species, scenario) %>% 
  mutate(habitat_change <- habitat - habitat[t == 25]) %>%
  ungroup()
invisible(gc())

```


## Step 3 - Population level plots (per species)

Population-level = value for the entire population (e.g. average of cell values for the entire population in a given time step)

For these plots the burn in period is not included in the graphical representation, since it corresponds to the preliminary steps of the model.

```{r, eval=FALSE}
##########################################
# STEP 3 - CREATE POPULATION LEVEL PLOTS #
##########################################

# calculate mean values
data_all_mean_stdev<-all_data[, c(1,4:10)]

# mean and standard deviation for ABUNDANCE, REPRODUCTION, CARRYING CAPACITY, HABITAT SUITABILITY and MORTALITY variables
mean_stDEV <- data_all_mean_stdev %>%
  dplyr::group_by(species, scenario, t) %>%
  dplyr::summarise(across(c(abundance, reproduction, carry, habitat, bevmort), .fns = list(mean = mean, sd = sd), na.rm = TRUE), .groups = 'drop') %>%
  dplyr::mutate(across(where(is.numeric), round, 3)) %>% 
  dplyr::filter(t>25) #remove burn-in

# write table into .csv file
write.csv(mean_stDEV, "mean_values_31Aug.csv", row.names=FALSE)
invisible(gc())
```

### Abundance through time

```{r, fig.dim=c(12,8)}
abund_plot
```

### Reproduction through time

```{r, fig.dim=c(12,8)}
reprod_plot
```

### Habitat suitability through time

```{r, fig.dim=c(12,8)}
habitat_plot
```

### Carrying capacity through time

```{r, fig.dim=c(12,8)}
carry_cap_plot
```

### Mortality through time

```{r, fig.dim=c(12,8)}
mort_plot
```

### Abundance mismatch

As of 30th August 2024, the abundance mismatch was calculated only for landscape cells considered suitable (meaning it was calculated only for cells where the habitat suitability in time step 90 increased in relation the habitat suitability in time step 25). Additionally only time step 90 was plotted.**

```{r, eval=FALSE}
abund_mismatch_df <- all_data[which(all_data$habitat_change >0), ]
invisible(gc())

abund_mismatch_df <- abund_mismatch_df[abund_mismatch_df$t==90,]
invisible(gc())
#summary(abund_mismatch_df)

# abundance mismatch
abund_mismatch_df <- abund_mismatch_df %>%
   group_by(species, scenario) %>% 
   mutate(abund_mismatch <- carry - abundance) %>%
   ungroup() %>% 
  rename(abund_mismatch = 15)
invisible(gc())

```

#### Abundance mismatch (in suitable cells for time step 90) boxplots with outliers"

```{r, fig.dim=c(12,8)}
abund_mismatch_plot
```

#### Abundance mismatch (in suitable cells for time step 90) boxplots without outliers and the 10% and 90% quantiles

```{r, fig.dim=c(12,8)}
abund_mismatch_plot2
```

## Step 4 - Cell-level plots (per species)

```{r, eval=FALSE}
##################################################
# STEP 4 - CREATE CELL LEVEL PLOTS (per species) #
##################################################

# abundance change proportion
all_data <- all_data %>%
  group_by(species, scenario) %>% 
  mutate(abund_change_prop <- (abundance - abundance[t == 25])/abundance[t == 25]) %>%
  rename(abund_change_prop = 15)  %>% 
  ungroup()
invisible(gc())


# subset data for the last time step (t = 90)
abund_t90<-all_data[all_data$t == 90,]
abund_t90$abund_change <- as.numeric(abund_t90$abund_change) # the plot scale does not work if the abund_chnage is in integer64 format

#get the names of each scenario
scenarios <- unique(abund_t90$scenario)

# Define the RdBu palette with a midpoint at 0
palette <- brewer.pal(11, "RdBu")

```

These plots were created with for loops to allow for an image with a map per species for each scenario. In total there are 7 images with 11 maps each. Check this folder [here](https://ulisboa-my.sharepoint.com/:u:/g/personal/misilva_fc_ul_pt/EdOWfZDeu49AuI5QG-zZF2EBjFwhT4NW0h_G4P3KCWovAg?e=MHeTBM) for those figures.

An extra plot was created representing Spatial hotspots of change in the landscape across all 11 species (MPCAS = Mean proportion of change across species). 

```{r, fig.dim=c(12,8)}
spatial_hotspots_map
```


```{r, fig.dim=c(12,8)}
correlation_plot
```


## Step 5 - Sensitivity analyses (per species)

Check this [script](https://github.com/andrepsilvadev/MetaRange/blob/dev/src/BLIZ1.6_SensitivityAnalysis_29Jul.R) to see how the sensitivity analysis was done.

See [here](https://ulisboa-my.sharepoint.com/:i:/g/personal/misilva_fc_ul_pt/EffaapZbrzZEs-0oVg3lPvwBWhNx9-xTwXzVfqNOgx0m2A?e=ETb0Xc) image from 29th July 2024. 
