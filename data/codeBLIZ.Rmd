---
title: "code BLIZ"
author: "Leticia Duarte"
output: 
  html_notebook:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: inline
---

<style type="text/css">

body{ /* Normal  */
      font-size: 13px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 20px;
  font-weight: bold;
}
h1 { /* Header 1 */
  font-size: 20px;
  font-weight: bold;
}
h2 { /* Header 2 */
    font-size: 17px;
  font-weight: bold;
}
h3 { /* Header 3 */
    font-size: 15px;
  font-weight: bold;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre{ /* Code block - determines code spacing between lines */
    font-size: 12px;
}
h1, .h1, h2, .h2, h3, .h3, h4, .h4 {
    margin-top: 24xpx;
}
</style>


# Summary of the analyses

In **Step 1**, we prepared the candidate species for both Bavaria and Baden-Württemberg (BW).

- For Bavaria we used the species found in https://www.lfu.bayern.de/natur/rote_liste_pflanzen/doc/pflanzen/rl_pflanzen_nach_kategorien.pdf
It was hard to format the data, so there's a lot of code for that.

- For both Bavaria and BW we went to https://www.gbif.org/occurrence/search?occurrence_status=present&q= to download the species list with occurrences, and used the following filters: 
  - "Scientific name" - "Tracheophyta"
  - "Location" - "Including coordinates"
  - "Administrative areas" - "Bayern" or Baden-Württemberg"
  

In **Step 2** we looked for the available traits and checked which species had information for all traits.

For each trait we did the following steps:

- Download data
- Check units and methods used, and filter the useful data
- Select the columns with the measurements, methods and units
- Format data
- Merge data with the candidate species list prepared in Step 1

After checking and preparing all traits (Seed number, Growth rate, Wetmass, and Dispersal distance), we joined them, in order to see which species had information for them &rarr; **Complete data**

But because wetmass was a limiting variable, I decided to do a second compilation with species that had information for drymass in case there's a formula to convert drymass to wetmass &rarr; **Extra data**

We calculated mortality rate using an allometric equation with wetmass.

For carrying capacity (or max planting density), we had to search manually in FloraWeb and articles, since this trait did not appear in any databases.


Finally, we formatted all the data to compile information for the chosen species in one table.


In **Step 3**, we calculated the number of occurrences for the chosen species.


In **Step 4**, we mapped the occurrence data of the chosen species


Detailed information about each step can be found in the code below.


# 1 - Candidate species


## Species from Bavaria

Download red list of vascular plants from Bavaria (https://www.lfu.bayern.de/natur/rote_liste_pflanzen/doc/pflanzen/rl_pflanzen_nach_kategorien.pdf) and convert to csv

```{r}

plants_bavaria <- readLines("Data/Rote_List_Bayern.csv") #read csv as a text object

simplified_plants = paste(plants_bavaria, collapse = " ") #simplify data by collapsing everything with a space as delimiter

#run a for loop where we are looking for every "space + capital letter" and want to replace with a "new line + capital letter" - this was necessary because we had multiple species listed in one row
for (x in LETTERS) {
simplified_plants = gsub(paste0(" ",x), paste0("\n",x), simplified_plants)
}

#formatting data
sp_bavaria_red = 
  simplified_plants |>
  strsplit(split = "\n") |> #split lines in substrings
  unlist() |>
  gsub(paste0(" ","´"), paste0(""), x = _) |> #fix text (eliminate "´")
  gsub(paste0(" ","x"), paste0(""), x = _) |> #fix text (eliminate "x")
  unique() #remove duplicates

sp_bavaria_red <- data.frame(sp_bavaria_red) #transform into dataframe
colnames(sp_bavaria_red) <- c('species') #change name of id column

```


Download list of species with occurrences in Bavaria from GBIF database (https://www.gbif.org/occurrence/search?occurrence_status=present&q=), and use the following filters: 
  - "Scientific name" - "Tracheophyta"
  - "Location" - "Including coordinates"
  - "Administrative areas" - "Bayern"
  
(All occurrence data in BIEN is from GBIF, so there was no need to use both databases)
  
```{r}

GBIF_bav <- read.csv("Data/SpeciesList_Bavaria.csv", sep = "\t") #read file

sp_bav <- GBIF_bav[c("species")] #select column with species names
sp_bav <- sp_bav[sp_bav$species != "", , drop=FALSE] #eliminate empty rows

```


## Species from Baden-Württemberg (BW)

Download list of species with occurrences in BW from GBIF database (https://www.gbif.org/occurrence/search?occurrence_status=present&q=), and use the following filters: 
  - "Scientific name" - "Tracheophyta"
  - "Location" - "Including coordinates"
  - "Administrative areas" - "Baden-Württemberg"
  

```{r}

GBIF_baden <- read.csv("Data/SpeciesList_Baden.csv", sep = "\t") #read file

sp_baden <- GBIF_baden[c("species")] #select column with species names
sp_baden <- sp_baden[sp_baden$species != "", , drop=FALSE]#eliminate empty rows

```

## Candidate species list

```{r}

GBIF_Species <- merge(sp_bav,sp_baden, by = "species", all = TRUE) #merge both lists from GBIF
BB_Species <- merge(GBIF_Species,sp_bavaria_red, by = "species", all = TRUE) #merge GBIF data with Red List data

length(unique(BB_Species$species)) #calculate number of candidate species

```

# 2 - Traits

## Number of Seeds - reproductive rate

Download "Seed number" file from LEDA database (https://uol.de/en/landeco/research/leda/data-files)
Files (.txt) from this database have formatting problems - need to remove manually the first few rows to be read

**Brief summary:**
Filtered only values with **reproduction.unit.measured = 'per ramet/tussock or individual plant '** &rarr; Check if you want me to consider other units. For the methods used, considered all of them &rarr; Check if you want me to only consider some.

```{r}

seed_number <- read.csv2("Data/seed_number.txt", quote = "", dec = ".") #read file

unique(seed_number$reproduction.unit.measured) #check units measured
unique(seed_number$general.method) #check methods used

SeedNumber <- subset(seed_number, reproduction.unit.measured == 'per ramet/tussock or individual plant ') #filter rows with reproduction.unit.measured = 'per ramet/tussock or individual plant '
SeedNumber <- SeedNumber[c("SBS.name","single.value","general.method","reproduction.unit.measured")] #select columns with species, values, methods and units
names(SeedNumber)[names(SeedNumber) == 'SBS.name'] <- 'species' #change column name
names(SeedNumber)[names(SeedNumber) == 'single.value'] <- 'seed_number' #change column name

str(SeedNumber) #check if values are all numeric

merge_seeds <- merge(BB_Species, SeedNumber, by = "species") #merge data with candidate species list

length(unique(merge_seeds$species)) #check the number of species with data for this trait

```

## Growth Rate

Download "587 - plant growth rate" from TRY database (https://www.try-db.org/TryWeb/Home.php)

**Brief summary:**
Filtered only values with **method = 'ann. rad. gr'** and with **unit = "mm"**, in order to be consistent.

```{r}

growth_rate <- read.delim("Data/PlantGrowthRate.txt") #read file

GrowthRate <- subset(growth_rate, TraitID == 587) # filter rows with growth rate values - the database has other information

unique(GrowthRate$OrigUnitStr) #check units measured
unique(GrowthRate$OriglName) #check methods used

GrowthRate <- subset(GrowthRate, OrigUnitStr == 'mm' & OriglName == 'ann. rad. gr') #filter rows with OrigUnitStr = "mm" and OriglName = "ann. rad.gr"
GrowthRate <- GrowthRate[c("AccSpeciesName","OriglName","OrigValueStr","OrigUnitStr")] #select columns with species, values, methods and units
names(GrowthRate)[names(GrowthRate) == 'AccSpeciesName'] <- 'species' #change name
names(GrowthRate)[names(GrowthRate) == 'OriglName'] <- 'growth_method' #change name
names(GrowthRate)[names(GrowthRate) == 'OrigValueStr'] <- 'growth_rate_mm' #change name
names(GrowthRate)[names(GrowthRate) == 'OrigUnitStr'] <- 'growth_unit' #change name

str(GrowthRate) #check if values are all numeric
#if not numeric, go check if any values are wrong
#edit the wrong values manually (there was a value with "o.5" instead of "0.5" (row name 20759) & "0.2.5" instead of "0.25" (row name 23795)) using the code below:
#GrowthRate <- edit(GrowthRate)

GrowthRate$growth_rate_mm <- as.numeric(GrowthRate$growth_rate_mm) #convert column with values to numeric instead of character

merge_growth <- merge(BB_Species, GrowthRate, by = "species") #merge data with candidate species list

length(unique(merge_growth$species)) #check the number of species with data for this trait

```



## Wetmass

Download "3025 - plant wet biomass" from TRY database (https://www.try-db.org/TryWeb/Home.php)

Brief summary:
Didn't need to filter units or methods because they were all the same (g and whole plant fresh mass).

```{r}

plant_fresh_mass <- read.delim("Data/PlantFreshMass.txt") #read file

PlantFreshMass <- subset(plant_fresh_mass, TraitID == 3407) #filter rows with fresh mass values - the database has other information

unique(PlantFreshMass$OrigUnitStr) #check units measured
unique(PlantFreshMass$DataName) #check methods used

PlantFreshMass <- PlantFreshMass[c("AccSpeciesName","DataName","OrigValueStr","OrigUnitStr")] #select columns with species, values, methods and units
names(PlantFreshMass)[names(PlantFreshMass) == 'AccSpeciesName'] <- 'species' #change name
names(PlantFreshMass)[names(PlantFreshMass) == 'DataName'] <- 'P_part' #change name
names(PlantFreshMass)[names(PlantFreshMass) == 'OrigValueStr'] <- 'wetmass_g' #change name
names(PlantFreshMass)[names(PlantFreshMass) == 'OrigUnitStr'] <- 'Unit' #change name

str(PlantFreshMass) #check if values are all numeric
#if not numeric, go check if any values are wrong (no problems)
PlantFreshMass$wetmass_g <- as.numeric(PlantFreshMass$wetmass_g) #convert column with values to numeric instead of character

merge_fresh_mass <- merge(BB_Species, PlantFreshMass, by = "species") #merge data with candidate species list

```


Download data from Supporting Information of "PlantNE: a global database of plant biomass from nitrogen-addition experiments" (https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/ecy.2840)

**Brief summary:**
Used the biomass data from the control groups used in this study (column CK_M).
Filtered data with unit "g" and "g " because they are the same, and to be consistent.

```{r}

plantNE_data <- read.csv("Data/PlantNE_Biomass.csv", dec = ".") #read file

unique(plantNE_data$Unit) #check units measured
unique(plantNE_data$P_part) #check part of the plant measured

plantNE <- subset(plantNE_data, Unit %in% c('g','g ') & P_part == 'WP') #filter rows with unit = "g" and plant part = "whole plant"
plantNE <- plantNE[c("Species","CK_M","Unit","P_part")] #select columns with species, values, methods and units
names(plantNE)[names(plantNE) == 'Species'] <- 'species' #change name
names(plantNE)[names(plantNE) == 'CK_M'] <- 'wetmass_g' #change name

str(plantNE) #check if values are all numeric

merge_plantNE <- merge(BB_Species, plantNE, by = "species") #merge data with candidate species list

```

Join data from both databases

```{r}

Wetmass <- rbind(PlantFreshMass, plantNE)

length(unique(Wetmass$species)) #check the number of species with data for this trait

```

## Dispersal Distance

Download data from the Supporting Information of "Seed dispersal distance classes and dispersal modes for the European flora" (https://onlinelibrary.wiley.com/doi/full/10.1111/geb.13712)

**This article has the data in dispersal classes:**

Dispersal distance classes from Vittoz, P., & Engler, R. (2007). Seed dispersal distances: A typology based on dispersal modes and plant traits. Botanica Helvetica, 117, 109–124.

(dispersal distances in m for 50 and 99% seeds)

- class 1: 0.1-1 m

- class 2: 1-5 m

- class 3: 2-15 m

- class 4: 40-150 m

- class 5: 10-500 m

- class 6: 400-1500 m 

- (class 7: 500-5000 m - **excluded this class because it's dispersal by humans and that data exists only for some species**)

**&rarr; Used the 99% distribution kernels as the maximum distance**

**&rarr; Used the 50% distribution kernels as the mean distance**

```{r}

dispersal <- read.csv2("Data/Lososova_et_al_2023_Dispersal.csv") #read file

Dispersal <- dispersal[c("Taxon","Dispersal.distance.class..1.6.")] #select columns with species and dispersal class
names(Dispersal)[names(Dispersal) == 'Taxon'] <- 'species' #change name
names(Dispersal)[names(Dispersal) == 'Dispersal.distance.class..1.6.'] <- 'dispersal_class_1-6' #change name

##convert class data in mean distance and max distance
dispersal_key = read.csv("Data/dispersal_classes.csv") #read file with dispersal classes and respective mean and max values

#assign max and mean values for each row
for (row in seq_len(nrow(dispersal_key))) {
    curr_class = dispersal_key[row, "class"]
    curr_mean = dispersal_key[row, "mean_dist_m"]
    curr_max = dispersal_key[row, "max_dist_m"]
    
    Dispersal$mean_dist_m[Dispersal$'dispersal_class_1-6' == curr_class] = curr_mean
    Dispersal$max_dist_m[Dispersal$'dispersal_class_1-6' == curr_class] = curr_max
}

str(Dispersal) #check if values are all numeric

merge_dispersal <- merge(BB_Species, Dispersal, by = "species") #merge data with candidate species list

length(unique(merge_dispersal$species)) #check the number of species with data for this trait


```


## (Dry mass)

Download "3451 - Plant biomass and allometry: Plant dry mass" and "700 - Plant biomass and allometry: Plant dry mass" from TRY database (https://www.try-db.org/TryWeb/Home.php)

**Brief summary:**
Excluded data that was from only some parts of the plant or from young plants.
Used the column "StdValue" (which had the standard values in g), instead of the "OrigValueStr" (which had multiple units).

```{r}
dry_mass <- read.delim("Data/PlantDryMass.txt") #read file

DryMass <- subset(dry_mass, TraitID == 700) # filter rows with drymass values - the database has other information

unique(DryMass$OrigUnitStr) #check units measured
unique(DryMass$OriglName) #check methods used

DryMass <- subset(dry_mass, !OriglName %in% c('total dry mass (Excl. leaf)','Plant dry mass (2 week seedling)','Root.Bio')) #filter rows with the correct data - in this case I eliminated the rows where they measured just a part of the plant
DryMass <- DryMass[c("AccSpeciesName","OriglName","StdValue","UnitName")] #select columns with species, values, methods and units
names(DryMass)[names(DryMass) == 'AccSpeciesName'] <- 'species' #change name
names(DryMass)[names(DryMass) == 'OriglName'] <- 'drymass_method' #change name
names(DryMass)[names(DryMass) == 'StdValue'] <- 'drymass_g' #change name
names(DryMass)[names(DryMass) == 'UnitName'] <- 'drymass_unit' #change name

str(DryMass) #check if values are all numeric

merge_drymass <- merge(BB_Species, DryMass, by = "species") #merge data with candidate species list

length(unique(merge_drymass$species)) #check the number of species with data for this trait

```


# 2A - Join all trait data

## 1) Complete data

Complete data includes: seed number, growth rate, wetmass from TRY and PlantNE databases, and max and mean dispersal distances

Mortality wasn't included because it will be calculated from wetmass in the final table

Carrying capacity wasn't included yet because it has to be checked manually, and for that we need to check first which species have data for the other traits.

```{r}

traits <- 
  BB_Species |> 
  merge(SeedNumber, by = "species") |> 
  merge(GrowthRate, by = "species") |>
  merge(Wetmass, by = "species") |>
  merge(Dispersal, by = "species")
  
unique(traits$species)  #check the number of species with data for all traits

print(traits)

```


## 2) Extra data

Extra data includes: seed number, growth rate, drymass, mortality rate, max and mean dispersal distances

Drymass was included in case there's a formula to convert drymass in wetmass.


```{r}

traits_extra <- 
  BB_Species |> 
  merge(SeedNumber, by = "species") |> 
  merge(GrowthRate, by = "species") |>
  merge(DryMass, by = "species") |>
  merge(Dispersal, by = "species")
  
unique(traits_extra$species) #check the number of species with data for all traits

```

# 2B - Formatting final trait data

First, we have to add the trait information missing

## Mortality rate

Mortality rate was calculated from biomass with the allometric equation from Marba, N., Duarte, C.M. & Agustí S. (2007) Allometric scaling of plant life history. Proceedings of the National Academy of Sciences of the United States of America, 104, 15777–15780. (https://www.pnas.org/doi/abs/10.1073/pnas.0703476104)

“Marba et al. (2007)  applied allometric theory to the relationship between size and important life-history parameters and reported that mortality and birth rates scaled as **the –0.25 power and life span as the 0.25 power of plant mass from phytoplankton to trees**.” (https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.1365-2745.2008.01415.x) 


```{r}

library(dplyr) #to use mutate function

Mortality <- Wetmass %>% mutate(mortality = -0.25^wetmass_g) #calculated from wetmass
Mortality <- Mortality[c("species","mortality")] #select columns with species and values


Mortality_dry <- DryMass %>% mutate(mortality_drymass = -0.25^drymass_g) #calculated from drymass


```


## Carrying capacity 
(or max planting density) 
Searched manually for each species that had data for the above traits. First, searched in FloraWeb for  "max planting density (plants/acre)". Then, searched in papers and other sites. 

Convert all data to plants/m2.

Build table with data for the species we could find.

References for this data:


```{r}

#read file

Density



```


## Add missing data

### 1) Complete data

```{r}

traits <- 
  traits |> 
  merge(Mortality, by = "species")
  
unique(traits$species)  #check the number of species with data for all traits

print(traits)

```

### 2) Extra data

```{r}

traits_extra <- 
  traits_extra |> 
  merge(Mortality_dry, by = "species") |> 
  merge(Density, by = "species")
  
unique(traits_extra$species) #check the number of species with data for all traits

```

## Calculate mean and standard deviation for each trait

Calculated the mean and the standard deviation for each species for each trait.

```{r}

#select only columns with the values for final table
simplified_traits <- traits[,c("species","seed_number","mean_dist_m","max_dist_m","growth_rate_mm","wetmass_g","mortality")]

#create final table
final <- simplified_traits[seq_along(unique(simplified_traits$species)),]

#delete data from table
final[TRUE, TRUE] = NA

#add species to column
final$species = unique(simplified_traits$species)

#add traits

for (row in seq_len(nrow(final))) { #for each row (aka species) in the final table
  sp = final$species[row] #get the species name
  sp_rows = simplified_traits[simplified_traits$species == sp,] #get the rows for that species from the simplified_traits dataframe

  for (col in seq_len(ncol(sp_rows))) { #for each column (aka trait)
    if (col == 1) next #skip species column

    if (length(unique(sp_rows[,col])) == 1) { #if there is only one unique value for that trait
      final[row,col] = sp_rows[1,col] #the only value becomes the final value
    } else { #if there are multiple values
      if (is.character(sp_rows[,col])) { #must be numeric, else stop function
        stop("You have a character value in this column!")
      } else { #if is numeric
        final[row,col] = mean(sp_rows[,col]) #calculate the mean and assign to its spot in the final table
      }
    }
  }
}

print(final)

```


```{r}

#select only columns with the values for final table

simplified_traits_extra <- traits_extra[,c("species","seed_number","mean_dist_m","max_dist_m","growth_rate_mm","drymass_g")]

#create final table
final_extra <- simplified_traits_extra[seq_along(unique(simplified_traits_extra$species)),]

#delete data from table
final_extra[TRUE, TRUE] = NA

#add species to column
final_extra$species = unique(simplified_traits_extra$species)

#add traits

for (row in seq_len(nrow(final_extra))) {
  sp_extra = final_extra$species[row]
  cat("Analyzing", sp, "\n")
  sp_rows_extra = simplified_traits_extra[simplified_traits_extra$species == sp_extra,]
  for (col in seq_len(ncol(sp_rows_extra))) {
    if (col == 1) next
    cat(paste0("\tAnalyzing column", colnames(sp_rows_extra)[col], "..."))
    if (length(unique(sp_rows_extra[,col])) == 1) {
      cat("All values equal.\n")
      final_extra[row,col] = sp_rows_extra[1,col]
    } else {
      if (is.character(sp_rows_extra[,col])) {
        stop("You have a character value in this column!")
      } else {
        cat("Calculated mean.\n")
        final_extra[row,col] = mean(sp_rows_extra[,col])
      }
    }
  }
}

print(final_extra)

```


**Export data**

```{r}
#tables with units and other information
write.csv(traits, "Results/traits_complete.csv")
write.csv(traits_extra, "Results/traits_extra.csv")

#final table
merge_final <- merge(final, final_extra, by = intersect(colnames(final), colnames(final_extra)), all = TRUE)
write.csv(merge_final, "Results/final_traits.csv")

```


# 3 - Occurrence data


```{r}
sp <- data.frame(unique(traits$species)) #get species names included in the complete data
names(sp)[names(sp) == 'unique.traits.species.'] <- 'species' #change column name

```


## Calculate occurrences in Bavaria for each species

```{r}

gbif_bav <- merge(sp, GBIF_bav, by = "species") #get occurrence data from Bavaria for the species included in the complete data

occur_sp_bav <- aggregate(numberOfOccurrences ~ species, data=gbif_bav, sum) #calculate number of occurrences for each species

names(occur_sp_bav)[names(occur_sp_bav) == 'numberOfOccurrences'] <- 'numberOfOccurrences_bav' #change column name

```

## Calculate occurrences in BW for each species

```{r}

gbif_bw <- merge(sp, GBIF_baden, by = "species") #get occurrence data from BW for the species included in the complete data

occur_sp_bw <- aggregate(numberOfOccurrences ~ species, data=gbif_bw, sum) #calculate number of occurrences for each species

names(occur_sp_bw)[names(occur_sp_bw) == 'numberOfOccurrences'] <- 'numberOfOccurrences_bw' #change column name

```

## Calculate occurrences in Bavaria + BW for each species

```{r}

occur <- merge(occur_sp_bav, occur_sp_bw, by = "species", all=TRUE) #merge occurrences from Bavaria and BW

occur$numberOfOccurrences <- rowSums(cbind(occur$numberOfOccurrences_bav,occur$numberOfOccurrences_bw),na.rm=TRUE) #sum occurrences

print(occur)

write.csv(occur, "Results/Occurrences_bav&bw.csv") #download occurrence file

```


## Calculate occurrences worldwide for each species

```{r}
#import occurrences data

AM <- readr::read_csv(unzip("Data/Occurrences/Achillea_millefolium_occurrences.zip", "Achillea_millefolium_occurrences.csv"))


```



## Map occurrences

```{r}


```




<br><br>
<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
